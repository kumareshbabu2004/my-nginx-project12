name: Build, Push, Deploy with Rollback and Email

on:
  push:
    branches: [main]

jobs:
  build:
    name: 🛠️ Build Docker Image
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.set_tag.outputs.version }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Generate Image Tag
        id: set_tag
        run: |
          VERSION="v$(date +'%Y.%m.%d.%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Pull Latest as Rollback
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:latest || echo "No previous latest image found"

      - name: Tag Latest as Rollback (if exists)
        run: |
          docker tag ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:latest ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:rollback || true

      - name: Build New Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:${{ steps.set_tag.outputs.version }} .
          docker tag ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:${{ steps.set_tag.outputs.version }} ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:latest

      - name: Push All Tags
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:${{ steps.set_tag.outputs.version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:rollback || echo "No rollback image to push"

  deploy:
    name: 🚀 Deploy Container
    needs: build
    runs-on: self-hosted

    steps:
      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Pull and Run New Image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:latest
          docker stop myapp || true
          docker rm myapp || true
          docker run -d --name myapp -p 81:80 ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:latest

  rollback:
    name: 🔁 Rollback If Deploy Fails
    needs: deploy
    if: failure()
    runs-on: self-hosted

    steps:
      - name: Run Rollback Container
        run: |
          docker stop myapp || true
          docker rm myapp || true
          docker pull ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:rollback
          docker run -d --name myapp -p 81:80 ${{ secrets.DOCKER_USERNAME }}/my-nginx-app:rollback

  notify:
    name: 📧 Send Email Notification
    needs: [deploy, rollback]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Email
        run: |
          STATUS="${{ job.status }}"
          echo "Subject: Deployment $STATUS
          To: ${{ secrets.TO_EMAIL }}

          Workflow: ${{ github.workflow }}
          Status: $STATUS
          Commit: ${{ github.sha }}
          Repo: ${{ github.repository }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" > mail.txt

          curl --url 'smtps://smtp.gmail.com:465' --ssl-reqd \
            --mail-from "${{ secrets.GMAIL_USER }}" \
            --mail-rcpt "${{ secrets.TO_EMAIL }}" \
            --upload-file mail.txt \
            --user "${{ secrets.GMAIL_USER }}:${{ secrets.GMAIL_PASS }}" \
            --insecure
